---
import { Image } from 'astro:assets';
import { getEntry } from 'astro:content';
import clientsMobile from '../assets/clients-mobile.png';
import clients from '../assets/clients.png';
import heroMobile from '../assets/hero-mobile.png';
import hero from '../assets/hero.png';
import logo from '../assets/logo.svg';
import mapMobile from '../assets/map-mobile.png';
import map from '../assets/map.png';
import projectsMobile from '../assets/projects-mobile.png';
import projects from '../assets/projects.png';
import treesMobile from '../assets/trees-mobile.png';
import trees from '../assets/trees.png';
import '../styles/global.css';

import {
  ArrowDownIcon,
  BellRingIcon,
  BugOffIcon,
  Building2Icon,
  CircleFadingArrowUpIcon,
  ClockIcon,
  FileStackIcon,
  HistoryIcon,
  MapIcon,
  MenuIcon,
  Settings2Icon,
  TreesIcon,
  UserRoundIcon,
  XIcon,
} from '@lucide/astro';

// ============================================================================
// CONTENT FROM MARKDOWN FILES
// ============================================================================

// Icon mappings (icons can't be stored in markdown)
const iconMap = {
  UserRoundIcon,
  Building2Icon,
  TreesIcon,
  ClockIcon,
  MapIcon,
  FileStackIcon,
  HistoryIcon,
  Settings2Icon,
  BellRingIcon,
  BugOffIcon,
  CircleFadingArrowUpIcon,
} as const;

// Image mappings (images can't be stored in markdown)
const imageMap = {
  clients,
  clientsMobile,
  projects,
  projectsMobile,
  trees,
  treesMobile,
  map,
  mapMobile,
} as const;

// Load content from markdown files
const siteEntry = await getEntry('meta', 'site');
const heroEntry = await getEntry('sections', 'hero');
const forWhoEntry = await getEntry('sections', 'for-who');
const problemEntry = await getEntry('sections', 'problem');
const solutionEntry = await getEntry('sections', 'solution');
const upcomingEntry = await getEntry('sections', 'upcoming');
const newsletterEntry = await getEntry('sections', 'newsletter');
const faqEntry = await getEntry('sections', 'faq');

// Site metadata and navigation
const siteUrl = siteEntry!.data.siteUrl;
const meta = {
  title: siteEntry!.data.title,
  description: siteEntry!.data.description,
  ogImage: siteEntry!.data.ogImage,
  keywords: siteEntry!.data.keywords,
};
const nav = siteEntry!.data.nav;
const footer = siteEntry!.data.footer;

// Hero section
const heroSection = {
  microcopy: heroEntry!.data.microcopy!,
  title: heroEntry!.data.title!,
  description: heroEntry!.data.description!,
  cta: heroEntry!.data.cta!,
  imageAlt: heroEntry!.data.imageAlt!,
};

// For who section - map icons
const forWhoSection = {
  title: forWhoEntry!.data.title,
  items: forWhoEntry!.data.items!.map((item) => ({
    title: item.title,
    description: item.description,
    icon: iconMap[item.icon as keyof typeof iconMap],
  })),
};

// Problem section - map icons
const problemSection = {
  microcopy: problemEntry!.data.microcopy,
  title: problemEntry!.data.title,
  items: problemEntry!.data.items!.map((item) => ({
    text: item.text,
    icon: iconMap[item.icon as keyof typeof iconMap],
  })),
};

// Solution section - map images
const solutionSection = {
  microcopy: solutionEntry!.data.microcopy!,
  title: solutionEntry!.data.title!,
  description: solutionEntry!.data.description!,
  features: solutionEntry!.data.features!.map((feature) => ({
    microcopy: feature.microcopy,
    title: feature.title,
    description: feature.description,
    image: imageMap[feature.image as keyof typeof imageMap],
    mobileImage: imageMap[feature.mobileImage as keyof typeof imageMap],
  })),
};

// Upcoming section - map icons
const upcomingSection = {
  title: upcomingEntry!.data.title,
  description: upcomingEntry!.data.description,
  badge: upcomingEntry!.data.badge,
  items: upcomingEntry!.data.items!.map((item) => ({
    text: item.text,
    icon: iconMap[item.icon as keyof typeof iconMap],
  })),
};

// Newsletter section - map icons
const newsletterSection = {
  title: newsletterEntry!.data.title,
  description: newsletterEntry!.data.description,
  placeholder: newsletterEntry!.data.placeholder,
  cta: newsletterEntry!.data.cta,
  note: newsletterEntry!.data.note,
  benefitsTitle: newsletterEntry!.data.benefitsTitle,
  benefits: newsletterEntry!.data.benefits!.map((benefit) => ({
    text: benefit.text,
    icon: iconMap[benefit.icon as keyof typeof iconMap],
  })),
};

// FAQ section
const faqSection = {
  title: faqEntry!.data.title,
  description: faqEntry!.data.description,
  items: faqEntry!.data.faqItems!.map((item) => ({
    question: item.question,
    answer: item.answer,
  })),
};
---

<html lang="pl">
  <head>
    <!-- Google Tag Manager -->
    {
      import.meta.env.PROD && (
        <>
          <script>
            (function (w, d, s, l, i) {
              w[l] = w[l] || [];
              w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
              var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s),
                dl = l != 'dataLayer' ? '&l=' + l : '';
              j.async = true;
              j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
              f.parentNode.insertBefore(j, f);
            })(window, document, 'script', 'dataLayer', 'GTM-K92G4FQ5');
          </script>
        </>
      )
    }
    <!-- End Google Tag Manager -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />

    <!-- Primary Meta Tags -->
    <title>{meta.title}</title>
    <meta name="title" content={meta.title} />
    <meta name="description" content={meta.description} />
    <meta name="keywords" content={meta.keywords} />

    <!-- Canonical -->
    <link rel="canonical" href={siteUrl} />
    <link rel="sitemap" href="/sitemap-index.xml" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={siteUrl} />
    <meta property="og:title" content={meta.title} />
    <meta property="og:description" content={meta.description} />
    <meta property="og:image" content={`${siteUrl}${meta.ogImage}`} />
    <meta property="og:locale" content="pl_PL" />
    <meta property="og:site_name" content="TreeAgent" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={siteUrl} />
    <meta name="twitter:title" content={meta.title} />
    <meta name="twitter:description" content={meta.description} />
    <meta name="twitter:image" content={`${siteUrl}${meta.ogImage}`} />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

    <!-- Theme -->
    <meta name="theme-color" content="#1c1917" />

    <!-- Structured Data - SoftwareApplication -->
    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        '@context': 'https://schema.org',
        '@type': 'SoftwareApplication',
        name: 'TreeAgent',
        applicationCategory: 'BusinessApplication',
        operatingSystem: 'Web',
        description: meta.description,
        url: siteUrl,
        offers: {
          '@type': 'Offer',
          price: '0',
          priceCurrency: 'PLN',
        },
      })}
    />

    <!-- Structured Data - FAQ -->
    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        '@context': 'https://schema.org',
        '@type': 'FAQPage',
        mainEntity: faqSection.items.map((item) => ({
          '@type': 'Question',
          name: item.question,
          acceptedAnswer: {
            '@type': 'Answer',
            text: item.answer,
          },
        })),
      })}
    />
  </head><body class="bg-stone-50 text-stone-800 antialiased" id="">
    <!-- Google Tag Manager (noscript) -->

    {
      import.meta.env.PROD && (
        <>
          <noscript>
            <iframe
              src="https://www.googletagmanager.com/ns.html?id=GTM-K92G4FQ5"
              height="0"
              width="0"
              style="display:none;visibility:hidden"
            />
          </noscript>
        </>
      )
    }
    <!-- End Google Tag Manager (noscript) -->
    <main class="">
      <header class="py-4 sticky top-0 z-50 bg-stone-50/80 backdrop-blur-sm">
        <div
          class="flex items-center justify-between max-w-7xl w-full mx-auto px-6 md:px-10"
        >
          <a href="#"
            ><Image
              src={logo}
              alt="TreeAgent - system do inspekcji drzew"
              class="w-32"
              width="128"
              height="26"
            /></a
          >
          <nav
            class="hidden md:flex items-center gap-8 justify-center font-[450]"
          >
            {
              nav.items.map(({ label, href }) => (
                <a
                  href={href}
                  class="hover:text-stone-950 hover:underline underline-offset-2 transition-all"
                >
                  {label}
                </a>
              ))
            }
          </nav>
          <div class="flex items-center gap-3">
            <a
              href="#newsletter"
              class="bg-orange-600/80 hover:bg-orange-600 border border-orange-600 text-orange-50 w-fit px-3 py-1 rounded-full font-medium inline-flex items-center gap-1.5 transition-colors cursor-pointer"
            >
              {nav.signup}
            </a>
            <button
              type="button"
              id="mobile-menu-toggle"
              class="md:hidden inline-flex items-center justify-center text-stone-700 w-9 h-9"
              aria-expanded="false"
              aria-controls="mobile-menu"
              aria-label="OtwÃ³rz menu"
            >
              <MenuIcon class="size-5" />
            </button>
          </div>
        </div>
      </header>

      <div
        id="mobile-menu"
        class="md:hidden fixed inset-0 z-50 size-full bg-stone-100/95 backdrop-blur-sm p-6 hidden opacity-0 transition-opacity duration-200 overscroll-contain"
      >
        <button
          type="button"
          id="mobile-menu-close"
          class="absolute top-4 right-4 inline-flex items-center justify-center text-stone-700 w-9 h-9"
          aria-label="Zamknij menu"
        >
          <XIcon class="size-5" />
        </button>
        <nav
          class="grid gap-4 text-lg font-medium h-full justify-center content-center"
        >
          {
            nav.items.map(({ label, href }) => (
              <a href={href} class="py-1 mobile-menu-link text-3xl">
                {label}
              </a>
            ))
          }
        </nav>
      </div>

      <div class="max-w-7xl w-full mx-auto">
        <section class="px-6 md:px-10 mt-10 md:mt-24">
          <div>
            <small class="text-orange-600 font-medium text-sm uppercase"
              >{heroSection.microcopy}</small
            >
            <h1
              class="text-3xl md:text-5xl lg:text-6xl lg:max-w-3xl lg:leading-16 md:leading-14 font-medium text-balance mt-2 max-w-2xl tracking-tight"
            >
              {heroSection.title}
            </h1>
            <p
              class="font-[450] text-stone-600 leading-6 text-lg max-w-lg md:max-w-2xl text-balance mt-4"
            >
              {heroSection.description}
            </p>
            <a
              href="#funkcje"
              class="bg-stone-950 hover:bg-stone-800 border border-stone-600 text-stone-50 font-medium w-fit px-5 py-2 rounded-full mt-5.5 flex items-center gap-1.5 transition-colors cursor-pointer"
            >
              <span>{heroSection.cta}</span>
              <ArrowDownIcon class="size-4" />
            </a>
          </div>

          <Image
            src={hero}
            alt={heroSection.imageAlt}
            class="w-full aspect-video object-cover rounded-lg mt-20 max-md:hidden"
          />
          <Image
            src={heroMobile}
            alt={heroSection.imageAlt}
            class="w-full object-cover rounded-lg mt-12 md:hidden"
          />
        </section>

        <section id="dla-kogo" class="p-4 mt-12 md:mt-32 scroll-mt-20">
          <h2
            class="text-3xl md:text-4xl font-medium text-center tracking-tight"
          >
            {forWhoSection.title}
          </h2>
          <ul class="grid grid-flow-row md:grid-cols-3 gap-4 mt-12 md:mt-16">
            {
              forWhoSection.items.map(({ title, description }) => (
                <li class="bg-stone-200/10 p-4 rounded-lg border border-stone-200/75 flex flex-col justify-between gap-4 bg-lines">
                  <div class="flex items-center gap-1">
                    <p class="font-medium text-xl leading-tight text-stone-950">
                      {title}
                    </p>
                  </div>
                  <p class="text-stone-600 mt-1 border-stone-300 font-[450] md:text-lg md:text-balance">
                    {description}
                  </p>
                </li>
              ))
            }
          </ul>
        </section>

        <section class="p-4 mt-12 md:mt-32">
          <small
            class="text-red-600 font-medium text-sm text-center uppercase block"
            >{problemSection.microcopy}</small
          >
          <h2
            class="text-3xl md:text-4xl font-medium text-center text-balance mt-2 max-w-xl mx-auto tracking-tight"
          >
            {problemSection.title}
          </h2>
          <ul class="flex flex-col gap-4 mt-16 max-w-lg mx-auto">
            {
              problemSection.items.map(({ text, icon: Icon }) => (
                <li class="bg-stone-200/10 p-4 rounded-lg border border-stone-200/75 flex gap-2 text-red-600 md:text-lg">
                  <span>
                    <Icon class="w-4 md:w-5 h-lh opacity-75" />
                  </span>
                  <p class="font-[450]">{text}</p>
                </li>
              ))
            }
          </ul>
        </section>

        <section id="funkcje" class="p-4 mt-12 md:mt-32 scroll-mt-20">
          <small
            class="text-green-600 font-medium text-sm text-center uppercase block"
            >{solutionSection.microcopy}</small
          >
          <h2
            class="text-3xl md:text-4xl font-medium text-center text-balance mt-2 mx-auto tracking-tight"
          >
            {solutionSection.title.split('TreeAgent')[0]}<span
              class="text-green-600">TreeAgent</span
            >{solutionSection.title.split('TreeAgent')[1]}
          </h2>
          <p
            class="text-stone-600 mt-4 text-center text-balance max-w-[64ch] mx-auto font-[450] text-lg"
          >
            {solutionSection.description}
          </p>

          <div class="mt-16 grid gap-12">
            {
              solutionSection.features.map(
                ({ microcopy, title, description, image, mobileImage }) => (
                  <div class="group max-md:flex max-md:flex-col-reverse bg-stone-200/10 p-2 rounded-lg border md:gap-8 border-stone-200/75 grid md:grid-cols-[2fr_3fr] md:even:grid-cols-[3fr_2fr]">
                    <div class="flex flex-col gap-4 p-2 mt-4 px-4 md:mt-8 md:group-even:order-2">
                      <p class="font-medium text-2xl leading-tight text-stone-950 text-balance">
                        {title}
                      </p>
                      <p class="text-stone-600 text-balance border-stone-300 font-[450] md:text-lg">
                        {description}
                      </p>
                    </div>
                    <Image
                      src={image}
                      alt={`TreeAgent - ${title}`}
                      class="rounded-lg max-sm:hidden"
                    />
                    <Image
                      src={mobileImage}
                      alt={`TreeAgent - ${title}`}
                      class="rounded-lg sm:hidden"
                    />
                  </div>
                )
              )
            }
          </div>
        </section>

        <section class="p-4 mt-12 md:mt-32">
          <h2
            class="text-3xl md:text-4xl font-medium text-center text-balance tracking-tight"
          >
            {upcomingSection.title}
          </h2>
          <p
            class="text-stone-600 mt-4 text-center text-balance max-w-[64ch] mx-auto font-[450] text-lg"
          >
            {upcomingSection.description}
          </p>

          <ul class="flex flex-col gap-4 mt-16 max-w-lg mx-auto">
            {
              upcomingSection.items.map(({ text, icon: Icon }) => (
                <li class="bg-stone-200/10 p-4 rounded-lg border border-stone-200/75 flex gap-2 md:text-lg">
                  <span>
                    <Icon class="w-4 md:w-5 h-lh opacity-75" />
                  </span>
                  <p class="font-[450]">{text}</p>
                  <div class="bg-green-600/80 border border-green-600 text-green-50 w-fit px-3 py-0.5 rounded-full ml-auto text-sm self-baseline">
                    {upcomingSection.badge}
                  </div>
                </li>
              ))
            }
          </ul>
        </section>

        <section
          id="newsletter"
          class="p-4 mt-16 bg-stone-400/10 rounded-lg py-16"
        >
          <h2
            class="text-3xl md:text-4xl font-medium text-center text-balance tracking-tight"
          >
            {newsletterSection.title}
          </h2>
          <p
            class="text-stone-600 mt-4 text-center text-balance max-w-4xl mx-auto font-[450] text-lg"
          >
            {newsletterSection.description}
          </p>

          <div class="my-16">
            <div class="flex items-center gap-2 max-w-md mx-auto">
              <input
                type="email"
                placeholder={newsletterSection.placeholder}
                class="w-full py-2 px-4 rounded-full border bg-white/80 border-stone-200 outline-green-600/80 font-medium"
              />
              <button
                class="bg-stone-800 cursor-pointer text-white w-fit px-5 py-2 rounded-full whitespace-nowrap"
              >
                {newsletterSection.cta}
              </button>
            </div>
            <p
              class="text-stone-600 mt-3 text-center text-balance max-w-[64ch] mx-auto font-[450]"
            >
              {newsletterSection.note}
            </p>
          </div>

          <h3
            class="text-xl font-medium text-center text-balance max-w-[64ch] mx-auto"
          >
            {newsletterSection.benefitsTitle}
          </h3>

          <ul class="grid md:flex flex-wrap justify-center gap-2 mt-4 mx-auto">
            {
              newsletterSection.benefits.map(({ text, icon: Icon }) => (
                <li class="px-3 py-2 bg-white grid grid-cols-[auto_1fr] gap-2 rounded-lg border border-stone-200">
                  <Icon class="size-4 h-lh opacity-75" />
                  <span class="font-[450]">{text}</span>
                </li>
              ))
            }
          </ul>
        </section>

        <section id="faq" class="p-4 mt-12 md:mt-32 scroll-mt-20">
          <h2
            class="text-3xl md:text-4xl font-medium text-center tracking-tight"
          >
            {faqSection.title}
          </h2>
          <p
            class="text-stone-600 mt-3 text-center text-balance max-w-[64ch] mx-auto font-[450] text-lg"
          >
            {faqSection.description}
          </p>
          <div
            class="divide-y divide-slate-200 mt-16 max-w-2xl mx-auto space-y-4"
          >
            {
              faqSection.items.map((faq, index) => (
                <div class="py-2 faq-item">
                  <h2>
                    <button
                      id={`faqs-title-${index}`}
                      type="button"
                      class="faq-toggle flex items-center justify-between w-full text-left  text-xl font-medium py-2"
                      aria-expanded="false"
                      aria-controls={`faqs-text-${index}`}
                    >
                      <span>{faq.question}</span>
                      <svg
                        class="faq-icon fill-stone-800 shrink-0 ml-8"
                        width="16"
                        height="16"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <rect
                          y="7"
                          width="16"
                          height="2"
                          rx="1"
                          class="faq-icon-horizontal transform origin-center transition duration-200 ease-out"
                        />
                        <rect
                          y="7"
                          width="16"
                          height="2"
                          rx="1"
                          class="faq-icon-vertical transform origin-center rotate-90 transition duration-200 ease-out"
                        />
                      </svg>
                    </button>
                  </h2>
                  <div
                    id={`faqs-text-${index}`}
                    role="region"
                    aria-labelledby={`faqs-title-${index}`}
                    class="faq-content grid overflow-hidden transition-all duration-300 ease-in-out grid-rows-[0fr] opacity-0"
                  >
                    <div class="overflow-hidden">
                      <p class="pb-3  text-stone-600 text-balance font-[450] md:text-lg">
                        {faq.answer}
                      </p>
                    </div>
                  </div>
                </div>
              ))
            }
          </div>
        </section>

        <footer class="overflow-hidden pt-24 border-t border-stone-200/75">
          <p
            class="translate-y-1/5 text-center font-bold text-stone-600/10 text-6xl md:text-9xl"
          >
            {footer.brand}
          </p>
        </footer>
      </div>
    </main>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Mobile menu
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const mobileMenuClose = document.getElementById('mobile-menu-close');
        const mobileMenuLinks = document.querySelectorAll('.mobile-menu-link');

        function openMobileMenu() {
          mobileMenu?.classList.remove('hidden');
          document.body.classList.add('overflow-hidden');
          requestAnimationFrame(() => {
            mobileMenu?.classList.remove('opacity-0');
            mobileMenu?.classList.add('opacity-100');
          });
          mobileMenuToggle?.setAttribute('aria-expanded', 'true');
        }

        function closeMobileMenu() {
          mobileMenu?.classList.remove('opacity-100');
          mobileMenu?.classList.add('opacity-0');
          document.body.classList.remove('overflow-hidden');
          mobileMenu?.addEventListener(
            'transitionend',
            () => {
              mobileMenu?.classList.add('hidden');
            },
            { once: true }
          );
          mobileMenuToggle?.setAttribute('aria-expanded', 'false');
        }

        mobileMenuToggle?.addEventListener('click', () => {
          const isOpen = !mobileMenu?.classList.contains('hidden');
          if (isOpen) {
            closeMobileMenu();
          } else {
            openMobileMenu();
          }
        });

        mobileMenuClose?.addEventListener('click', closeMobileMenu);

        mobileMenuLinks.forEach((link) => {
          link.addEventListener('click', closeMobileMenu);
        });

        // Remove overflow-hidden when resizing to desktop
        window.addEventListener('resize', () => {
          if (window.innerWidth >= 768) {
            document.body.classList.remove('overflow-hidden');
            mobileMenu?.classList.add('hidden', 'opacity-0');
            mobileMenu?.classList.remove('opacity-100');
            mobileMenuToggle?.setAttribute('aria-expanded', 'false');
          }
        });

        // FAQ accordion
        const faqToggles = document.querySelectorAll('.faq-toggle');

        faqToggles.forEach((toggle) => {
          toggle.addEventListener('click', () => {
            const faqItem = toggle.closest('.faq-item');
            const content = faqItem?.querySelector('.faq-content');
            const horizontalRect = toggle.querySelector('.faq-icon-horizontal');
            const verticalRect = toggle.querySelector('.faq-icon-vertical');
            const isExpanded = toggle.getAttribute('aria-expanded') === 'true';

            if (isExpanded) {
              // Collapse
              toggle.setAttribute('aria-expanded', 'false');
              content?.classList.remove('grid-rows-[1fr]', 'opacity-100');
              content?.classList.add('grid-rows-[0fr]', 'opacity-0');
              horizontalRect?.classList.remove('!rotate-180');
              verticalRect?.classList.remove('!rotate-180');
            } else {
              // Expand
              toggle.setAttribute('aria-expanded', 'true');
              content?.classList.remove('grid-rows-[0fr]', 'opacity-0');
              content?.classList.add('grid-rows-[1fr]', 'opacity-100');
              horizontalRect?.classList.add('!rotate-180');
              verticalRect?.classList.add('!rotate-180');
            }
          });
        });
      });
    </script>
  </body>
</html>
